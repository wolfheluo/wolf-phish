# Cretech-PHISH aaPanel Nginx 配置範例
# 
# 使用說明：
# 1. 在 aaPanel 中添加站點
# 2. 進入站點設置 > 配置文件
# 3. 將以下配置添加到 server 區塊中
# 4. 根據實際情況調整路徑和域名

# 主要 location 配置
location / {
    try_files $uri $uri/ /index.php?$query_string;
}

# PHP 處理（aaPanel 會自動配置，通常不需要修改）
location ~ \.php$ {
    include snippets/fastcgi-php.conf;
    fastcgi_pass unix:/tmp/php-cgi-81.sock;  # 根據 PHP 版本調整
    fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
    include fastcgi_params;
    fastcgi_hide_header X-Powered-By;
}

# 靜態文件緩存
location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
    expires 1y;
    add_header Cache-Control "public, immutable";
    try_files $uri =404;
}

# 上傳文件訪問
location /uploads/ {
    alias /var/www/cretech-phish/uploads/;
    autoindex off;
    
    # 只允許特定文件類型
    location ~* \.(jpg|jpeg|png|gif|pdf|zip|csv|html)$ {
        try_files $uri =404;
    }
    
    # 禁止執行 PHP
    location ~ \.php$ {
        deny all;
        return 404;
    }
}

# API 路由
location /api/ {
    try_files $uri $uri/ /index.php?$query_string;
    
    # API 限流（可選）
    # limit_req zone=api burst=20 nodelay;
}

# 追蹤端點
location /track/ {
    try_files $uri $uri/ /index.php?$query_string;
    # 追蹤日誌（可選）
    # access_log /var/log/nginx/tracking.log;
}

# 釣魚頁面
location /phish/ {
    try_files $uri $uri/ /index.php?$query_string;
    # 釣魚日誌（可選）
    # access_log /var/log/nginx/phishing.log;
}

# 健康檢查端點
location /health {
    access_log off;
    return 200 "healthy\n";
    add_header Content-Type text/plain;
}

# 隱藏敏感文件
location ~ /\. {
    deny all;
    access_log off;
    log_not_found off;
}

location ~ /\.git {
    deny all;
    access_log off;
    log_not_found off;
}

# 禁止訪問敏感目錄
location ~ ^/(config|database|scripts|src)/ {
    deny all;
    return 404;
}

# 安全頭設置（在 aaPanel 的站點設置中添加）
# 進入站點設置 > 配置文件，在 server 區塊中添加：
# add_header X-Frame-Options "SAMEORIGIN" always;
# add_header X-XSS-Protection "1; mode=block" always;
# add_header X-Content-Type-Options "nosniff" always;
# add_header Referrer-Policy "no-referrer-when-downgrade" always;
# add_header Content-Security-Policy "default-src 'self' http: https: data: blob: 'unsafe-inline'" always;

# SSL 重定向（在 aaPanel SSL 設置中可自動配置）
# if ($scheme != "https") {
#     return 301 https://$host$request_uri;
# }

# 限流配置（可選，在 nginx.conf 的 http 區塊中添加）
# limit_req_zone $binary_remote_addr zone=api:10m rate=10r/m;
# limit_req_zone $binary_remote_addr zone=general:10m rate=100r/m;

# 日誌配置（在 aaPanel 中通常自動設置）
# access_log /var/log/nginx/cretech-phish.access.log;
# error_log /var/log/nginx/cretech-phish.error.log warn;